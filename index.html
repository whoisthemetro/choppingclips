<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chop Suey</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --panel: rgba(20, 20, 30, 0.7);
            --glass: rgba(30, 30, 50, 0.4);
            --accent: #00f2ff;
            --text: #e0e0ff;
            --text-dim: #8888aa;
            --border: rgba(0, 242, 255, 0.3);
            --hover: rgba(0, 242, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Space Mono', 'Roboto Mono', monospace;
            min-height: 100vh;
            padding: 40px 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background Pulse */
        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(0,242,255,0.08) 0%, transparent 70%);
            animation: pulse 8s infinite ease-in-out;
            pointer-events: none;
            z-index: -1;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .container { max-width: 1000px; margin: 0 auto; }

        .header {
            text-align: center; margin-bottom: 40px;
            text-shadow: 0 0 10px rgba(0,242,255,0.3);
        }
        .header h1 {
            font-size: 48px; font-weight: 700; letter-spacing: 2px;
            background: linear-gradient(90deg, #00f2ff, #00aaff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .header p {
            color: var(--text-dim); font-size: 16px; letter-spacing: 1px;
        }

        .dark-toggle {
            position: absolute; top: 20px; right: 20px;
            background: var(--glass); color: var(--accent); border: 1px solid var(--border);
            padding: 10px; border-radius: 8px; cursor: pointer; font-size: 18px;
            backdrop-filter: blur(8px); transition: all 0.3s;
        }
        .dark-toggle:hover { background: var(--hover); box-shadow: 0 0 15px rgba(0,242,255,0.4); }

        /* Glass Panels */
        .file-path-container, .audio-container, .video-container, .clips-panel, .ffmpeg-commands {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        .file-path-container:hover, .audio-container:hover, .clips-panel:hover {
            box-shadow: 0 12px 40px rgba(0,242,255,0.15);
            transform: translateY(-2px);
        }

        .file-path-header, .audio-header, .clips-header h2 {
            color: var(--accent); font-size: 16px; font-weight: 700;
            letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 16px;
        }

        .file-path-input-group { display: flex; gap: 12px; align-items: center; }
        .file-path-input {
            flex: 1; background: rgba(10,10,20,0.6); border: 1px solid var(--border);
            color: var(--text); padding: 14px; border-radius: 10px;
            font-family: 'Roboto Mono', monospace; font-size: 14px;
            transition: all 0.3s; backdrop-filter: blur(4px);
        }
        .file-path-input:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 15px rgba(0,242,255,0.3);
        }

        .save-path-btn, .extract-audio-btn, .export-btn, .reset-btn, .add-clip-btn, .bulk-import-btn {
            background: var(--glass); color: var(--accent); border: 1px solid var(--border);
            padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 14px;
            cursor: pointer; transition: all 0.3s; backdrop-filter: blur(8px);
            letter-spacing: 1px;
        }
        .save-path-btn:hover, .extract-audio-btn:hover, .export-btn:hover, .add-clip-btn:hover, .bulk-import-btn:hover {
            background: var(--hover); box-shadow: 0 0 20px rgba(0,242,255,0.4);
            transform: translateY(-1px);
        }
        .reset-btn { color: #ff4d4d; border-color: #ff4d4d; }
        .reset-btn:hover { background: rgba(255,77,77,0.1); }

        .current-path { color: var(--accent); font-size: 13px; margin-top: 8px; font-family: 'Roboto Mono'; }

        .audio-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .audio-btn {
            background: rgba(10,10,20,0.6); color: var(--text-dim); border: 1px solid var(--border);
            padding: 10px 16px; border-radius: 8px; font-size: 13px; cursor: pointer;
            transition: all 0.3s; backdrop-filter: blur(4px);
        }
        .audio-btn:hover { border-color: var(--accent); color: var(--accent); }
        .audio-btn.selected { background: rgba(0,242,255,0.15); border-color: var(--accent); color: var(--accent); }

        .file-input-container { display: flex; align-items: center; gap: 12px; padding: 12px 0; }
        .file-input-label {
            background: var(--glass); color: var(--accent); padding: 10px 16px; border-radius: 8px;
            font-size: 13px; cursor: pointer; border: 1px solid var(--border); backdrop-filter: blur(8px);
        }
        .file-input-label:hover { background: var(--hover); }
        #videoFile { display: none; }
        .file-name { color: var(--text-dim); font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-name.selected { color: var(--accent); }

        video { width: 100%; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .controls {
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 16px; display: flex; align-items: center; gap: 12px; border-radius: 0 0 12px 12px;
        }
        .controls button svg { width: 22px; height: 22px; fill: var(--text); transition: fill 0.3s; }
        .controls button:hover svg { fill: var(--accent); }

        .progress-container { flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer; }
        .progress-bar { height: 100%; background: var(--accent); border-radius: 2px; width: 0%; box-shadow: 0 0 10px rgba(0,242,255,0.6); }

        .time { color: var(--text); font-size: 13px; min-width: 90px; text-align: center; font-family: 'Roboto Mono'; }

        .clips-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .clip-item {
            background: var(--glass); border: 1px solid var(--border); border-radius: 12px;
            padding: 18px; margin-bottom: 16px; backdrop-filter: blur(8px);
            transition: all 0.3s;
        }
        .clip-item:hover { border-color: var(--accent); box-shadow: 0 0 15px rgba(0,242,255,0.2); }

        .clip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .clip-title { color: var(--text); font-weight: 700; font-size: 15px; }
        .clip-btn.delete { background: rgba(255,77,77,0.1); color: #ff6b6b; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; }

        .clip-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .time-input label { color: var(--text-dim); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
        .time-input input {
            background: rgba(10,10,20,0.6); border: 1px solid var(--border); color: var(--text);
            padding: 8px; border-radius: 6px; font-family: 'Roboto Mono'; font-size: 13px; width: 100%;
        }
        .clip-duration { color: var(--text-dim); font-size: 12px; margin-top: 6px; }

        .no-clips { color: var(--text-dim); text-align: center; padding: 40px; font-size: 14px; }

        .screenshot-checkbox { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .screenshot-checkbox input { accent-color: var(--accent); width: 18px; height: 18px; }
        .screenshot-checkbox label { color: var(--text); font-size: 14px; cursor: pointer; }
        .screenshot-info { color: var(--text-dim); font-size: 12px; margin-left: 28px; }

        /* Encoding Options */
        .encoding-options { margin-bottom: 20px; padding: 16px; background: var(--glass); border-radius: 10px; border: 1px solid var(--border); }
        .encoding-header { color: var(--accent); font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 12px; }
        .encoding-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .encoding-btn {
            background: rgba(10,10,20,0.6); color: var(--text-dim); border: 1px solid var(--border);
            padding: 10px 16px; border-radius: 8px; font-size: 13px; cursor: pointer;
            transition: all 0.3s; backdrop-filter: blur(4px);
        }
        .encoding-btn:hover { border-color: var(--accent); color: var(--accent); }
        .encoding-btn.selected { background: rgba(0,242,255,0.15); border-color: var(--accent); color: var(--accent); }
        .encoding-note { color: var(--text-dim); font-size: 11px; margin-top: 10px; font-style: italic; }

        .export-buttons { display: flex; gap: 16px; margin: 20px 0; }
        .export-btn { flex: 1; background: linear-gradient(135deg, rgba(0,242,255,0.2), rgba(0,170,255,0.2)); }
        .reset-btn { flex: 1; }

        .ffmpeg-commands { display: none; }
        .ffmpeg-commands.show { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: none; } }

        .command-label { color: var(--accent); font-size: 12px; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 10px; }
        .command-text {
            background: rgba(10,10,20,0.8); color: #00ff88; padding: 16px; border-radius: 8px;
            font-family: 'Roboto Mono'; font-size: 13px; border: 1px solid rgba(0,255,136,0.3);
            word-break: break-all; margin-bottom: 12px;
        }
        .copy-btn {
            background: var(--glass); color: var(--accent); padding: 10px 16px; border-radius: 8px;
            font-size: 13px; border: 1px solid var(--border); backdrop-filter: blur(8px); cursor: pointer;
        }
        .copy-btn.copied { background: rgba(0,255,136,0.2); color: #00ff88; }

        .bulk-import-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .bulk-import-modal.show { display: flex; }
        .bulk-import-content {
            background: var(--panel); border: 1px solid var(--border); border-radius: 16px;
            padding: 32px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;
            backdrop-filter: blur(12px);
        }
        .bulk-import-title { color: var(--accent); font-size: 20px; font-weight: 700; margin-bottom: 16px; }
        .bulk-import-example {
            background: rgba(10,10,20,0.6); padding: 16px; border-radius: 8px; color: #00ff88;
            font-family: 'Roboto Mono'; font-size: 13px; margin-bottom: 20px; border: 1px solid rgba(0,255,136,0.3);
        }
        .bulk-import-textarea {
            width: 100%; min-height: 180px; background: rgba(10,10,20,0.6); border: 1px solid var(--border);
            color: var(--text); padding: 16px; border-radius: 10px; font-family: 'Roboto Mono'; font-size: 14px;
            resize: vertical; margin-bottom: 20px;
        }
        .bulk-import-textarea:focus { border-color: var(--accent); outline: none; }
        .bulk-import-cancel, .bulk-import-submit {
            background: var(--glass); color: var(--accent); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;
        }

        .notification {
            position: fixed; top: 20px; right: 20px; background: rgba(0,255,136,0.15); color: #00ff88;
            padding: 12px 20px; border-radius: 8px; font-weight: 700; z-index: 10000;
            border: 1px solid rgba(0,255,136,0.4); backdrop-filter: blur(8px);
            transform: translateX(400px); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .notification.show { transform: translateX(0); }

        .footer {
            text-align: center; padding: 40px 20px; color: var(--text-dim); font-size: 12px;
        }
        .footer a { color: var(--accent); text-decoration: none; }
    </style>
</head>
<body>
    <button class="dark-toggle" id="darkToggle">Dark Mode</button>
    <div class="container">
        <div class="header">
            <h1>Video Chop Suey</h1>
            <p>Precision video slicing • FFmpeg-powered • Zero bloat</p>
        </div>

        <!-- File Path -->
        <div class="file-path-container">
            <div class="file-path-header">Input Path</div>
            <div class="file-path-input-group">
                <input type="text" class="file-path-input" id="filePathInput" placeholder="C:\video.mp4 or /Users/name/video.mov">
                <button class="save-path-btn" id="savePathBtn">Lock</button>
            </div>
            <div class="current-path" id="currentPath" style="display:none;"></div>
        </div>

        <!-- Extract Audio -->
        <div class="audio-container">
            <div class="audio-header">Audio Extract</div>
            <div class="audio-buttons">
                <button class="audio-btn selected" data-audio="mp3">MP3</button>
                <button class="audio-btn" data-audio="wav">WAV</button>
                <button class="audio-btn" data-audio="none">None</button>
            </div>
            <button class="extract-audio-btn" id="extractAudioBtn">Generate</button>
        </div>

        <!-- Video Preview -->
        <div class="video-container" id="videoContainer" style="display:none;">
            <div class="file-input-container">
                <label for="videoFile" class="file-input-label">Load Preview</label>
                <input type="file" id="videoFile" accept="video/*">
                <span class="file-name" id="fileName">No file</span>
            </div>
            <video id="video" controls></video>
            <div class="controls">
                <button id="playPause"><svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><svg id="pauseIcon" viewBox="0 0 24 24" style="display:none;"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg></button>
                <div class="time"><span id="currentTime">0:00</span> / <span id="duration">0:00</span></div>
                <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
            </div>
        </div>

        <!-- Clips Panel -->
        <div class="clips-panel">
            <div class="clips-header">
                <h2>Timeline</h2>
                <div>
                    <button class="bulk-import-btn" id="bulkImportBtn">Paste</button>
                    <button class="add-clip-btn" id="addClipBtn">+ Clip</button>
                </div>
            </div>
            <div id="clipsList">
                <div class="no-clips">No segments. Add or paste timestamps.</div>
            </div>

            <div class="export-section">
                <div class="screenshot-option">
                    <div class="screenshot-checkbox">
                        <input type="checkbox" id="screenshotCheckbox">
                        <label for="screenshotCheckbox">Snapshot first frame</label>
                    </div>
                    <div class="screenshot-info">Generates .png at start of each clip</div>
                </div>

                <!-- Encoding Mode Selection -->
                <div class="encoding-options">
                    <div class="encoding-header">Encoding Mode</div>
                    <div class="encoding-buttons">
                        <button class="encoding-btn selected" data-mode="reencode" title="Re-encodes video for frame-accurate cuts (recommended)">Re-encode (Clean Cuts)</button>
                        <button class="encoding-btn" data-mode="copy" title="Fast but may have frozen frames at start">Stream Copy (Fast)</button>
                    </div>
                    <div class="encoding-note" id="encodingNote">Re-encode ensures clips start on exact frames with no frozen video. Slightly slower but recommended.</div>
                </div>

                <div class="export-buttons">
                    <button class="export-btn" id="exportBtn">Generate Command</button>
                    <button class="reset-btn" id="resetBtn">Clear All</button>
                </div>
                <div class="ffmpeg-commands" id="ffmpegCommands"></div>
            </div>
        </div>

        <!-- Bulk Import Modal -->
        <div class="bulk-import-modal" id="bulkImportModal">
            <div class="bulk-import-content">
                <div class="bulk-import-title">Bulk Import</div>
                <div class="bulk-import-example">00:10 - 00:25
01:30 - 02:15
03:00 - 03:45</div>
                <textarea class="bulk-import-textarea" id="bulkImportTextarea" placeholder="Paste MM:SS - MM:SS (one per line)..."></textarea>
                <div style="display:flex; gap:12px; justify-content:flex-end;">
                    <button class="bulk-import-cancel" id="bulkImportCancel">Cancel</button>
                    <button class="bulk-import-submit" id="bulkImportSubmit">Import</button>
                </div>
            </div>
        </div>

        <div class="footer">
            Engineered by whoistheMETRO • Neural upgrade by Claude
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('video');
            const videoContainer = document.getElementById('videoContainer');
            const filePathInput = document.getElementById('filePathInput');
            const savePathBtn = document.getElementById('savePathBtn');
            const currentPath = document.getElementById('currentPath');
            const videoFileInput = document.getElementById('videoFile');
            const fileName = document.getElementById('fileName');
            const audioBtns = document.querySelectorAll('.audio-btn');
            const extractAudioBtn = document.getElementById('extractAudioBtn');
            const addClipBtn = document.getElementById('addClipBtn');
            const bulkImportBtn = document.getElementById('bulkImportBtn');
            const bulkImportModal = document.getElementById('bulkImportModal');
            const bulkImportTextarea = document.getElementById('bulkImportTextarea');
            const bulkImportSubmit = document.getElementById('bulkImportSubmit');
            const bulkImportCancel = document.getElementById('bulkImportCancel');
            const clipsList = document.getElementById('clipsList');
            const exportBtn = document.getElementById('exportBtn');
            const resetBtn = document.getElementById('resetBtn');
            const ffmpegCommands = document.getElementById('ffmpegCommands');
            const screenshotCheckbox = document.getElementById('screenshotCheckbox');
            const encodingBtns = document.querySelectorAll('.encoding-btn');
            const encodingNote = document.getElementById('encodingNote');

            let clips = [];
            let clipIdCounter = 0;
            let videoFilePath = '';
            let audioFormat = 'mp3';
            let captureScreenshot = false;
            let videoDuration = 0;
            let encodingMode = 'reencode'; // Default to re-encode for clean cuts

            savePathBtn.addEventListener('click', () => {
                let path = filePathInput.value.trim();
                if ((path.startsWith('"') && path.endsWith('"')) || (path.startsWith("'") && path.endsWith("'"))) {
                    path = path.slice(1, -1);
                }
                if (path) {
                    videoFilePath = path;
                    currentPath.textContent = `Locked: ${path}`;
                    currentPath.style.display = 'block';
                    showNotification('Path locked');
                }
            });

            videoFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    video.src = url;
                    videoContainer.style.display = 'block';
                    fileName.textContent = file.name;
                    fileName.classList.add('selected');
                }
            });

            audioBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    audioBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    audioFormat = btn.dataset.audio;
                });
            });

            // Encoding mode selection
            encodingBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    encodingBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    encodingMode = btn.dataset.mode;
                    
                    if (encodingMode === 'reencode') {
                        encodingNote.textContent = 'Re-encode ensures clips start on exact frames with no frozen video. Slightly slower but recommended.';
                    } else {
                        encodingNote.textContent = '⚠️ Stream copy is fast but clips may have frozen frames at the start if cuts don\'t land on keyframes.';
                    }
                });
            });

            extractAudioBtn.addEventListener('click', () => {
                if (!videoFilePath) return showNotification('Set path first', 'error');
                generateAudioCommand();
            });

            addClipBtn.addEventListener('click', () => {
                const clipId = clipIdCounter++;
                clips.push({ id: clipId, start: 0, end: Math.min(30, videoDuration || 30), name: `Clip ${clips.length + 1}` });
                renderClips();
            });

            bulkImportBtn.addEventListener('click', () => {
                bulkImportModal.classList.add('show');
                bulkImportTextarea.focus();
            });
            bulkImportCancel.addEventListener('click', () => bulkImportModal.classList.remove('show'));
            bulkImportSubmit.addEventListener('click', () => {
                const lines = bulkImportTextarea.value.trim().split('\n');
                let added = 0;
                lines.forEach(line => {
                    const match = line.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/);
                    if (match) {
                        const start = MMSStoSec(match[1]);
                        const end = MMSStoSec(match[2]);
                        if (end > start && end <= (videoDuration || Infinity)) {
                            clips.push({ id: clipIdCounter++, start, end, name: `Clip ${clips.length + 1}` });
                            added++;
                        }
                    }
                });
                if (added > 0) {
                    renderClips();
                    bulkImportModal.classList.remove('show');
                    bulkImportTextarea.value = '';
                    showNotification(`${added} clips imported`);
                }
            });
            bulkImportModal.addEventListener('click', e => { if (e.target === bulkImportModal) bulkImportModal.classList.remove('show'); });

            video.addEventListener('loadedmetadata', () => {
                videoDuration = video.duration;
                document.getElementById('duration').textContent = formatTime(videoDuration);
                clips = clips.map(c => ({ ...c, end: Math.min(c.end, videoDuration) }));
                renderClips();
            });

            exportBtn.addEventListener('click', () => {
                if (!videoFilePath) return showNotification('Set path first', 'error');
                generateFFmpegCommands();
            });

            resetBtn.addEventListener('click', () => {
                if (confirm('Clear all data?')) {
                    clips = []; clipIdCounter = 0; videoFilePath = ''; captureScreenshot = false;
                    filePathInput.value = ''; currentPath.style.display = 'none';
                    screenshotCheckbox.checked = false;
                    renderClips();
                    ffmpegCommands.classList.remove('show');
                    showNotification('System reset');
                }
            });

            screenshotCheckbox.addEventListener('change', e => captureScreenshot = e.target.checked);

            function renderClips() {
                if (clips.length === 0) {
                    clipsList.innerHTML = '<div class="no-clips">No segments. Add or paste timestamps.</div>';
                    return;
                }
                clipsList.innerHTML = clips.map(clip => `
                    <div class="clip-item">
                        <div class="clip-header">
                            <div class="clip-title">${escapeHtml(clip.name)}</div>
                            <div><button class="clip-btn delete" data-id="${clip.id}">Delete</button></div>
                        </div>
                        <div class="clip-controls">
                            <div class="time-input">
                                <label>Start</label>
                                <input type="text" value="${secToMMSS(clip.start)}" class="start-input" data-id="${clip.id}">
                            </div>
                            <div class="time-input">
                                <label>End</label>
                                <input type="text" value="${secToMMSS(clip.end)}" class="end-input" data-id="${clip.id}">
                            </div>
                        </div>
                        <div class="clip-duration">Duration: ${formatTime(clip.end - clip.start)}</div>
                    </div>
                `).join('');
                attachClipListeners();
            }

            function attachClipListeners() {
                document.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        clips = clips.filter(c => c.id !== parseInt(btn.dataset.id));
                        renderClips();
                    });
                });
                document.querySelectorAll('.start-input, .end-input').forEach(input => {
                    input.addEventListener('blur', () => {
                        const id = parseInt(input.dataset.id);
                        const clip = clips.find(c => c.id === id);
                        const val = MMSStoSec(input.value);
                        if (!isNaN(val)) {
                            if (input.classList.contains('start-input')) clip.start = Math.max(0, val);
                            else clip.end = Math.min(videoDuration || Infinity, Math.max(clip.start + 1, val));
                        }
                        renderClips();
                    });
                });
            }

            function generateFFmpegCommands() {
                const dir = videoFilePath.includes('/') ? videoFilePath.substring(0, videoFilePath.lastIndexOf('/') + 1) :
                            videoFilePath.includes('\\') ? videoFilePath.substring(0, videoFilePath.lastIndexOf('\\') + 1) : '';
                const fileNamePart = videoFilePath.split(/[\\/]/).pop();
                const base = fileNamePart.includes('.') ? fileNamePart.substring(0, fileNamePart.lastIndexOf('.')) : fileNamePart;
                const ext = fileNamePart.includes('.') ? fileNamePart.substring(fileNamePart.lastIndexOf('.')) : '.mp4';
                const isWin = videoFilePath.includes('\\');
                const sep = isWin ? ' & ' : ' && ';
                const cmds = [];

                if (clips.length > 0) {
                    clips.forEach(clip => {
                        const name = clip.name.replace(/\s+/g, '_');
                        const out = `${dir}${base}_${name}${ext}`;
                        const duration = (clip.end - clip.start).toFixed(2);
                        
                        if (captureScreenshot) {
                            const png = `${dir}${base}_${name}.png`;
                            cmds.push(`ffmpeg -ss ${clip.start.toFixed(2)} -i "${videoFilePath}" -frames:v 1 "${png}"`);
                        }
                        
                        if (encodingMode === 'reencode') {
                            // Re-encode mode: -ss before -i for fast seeking, then re-encode for clean cuts
                            // Using CRF 18 for high quality, preset medium for balance of speed/quality
                            cmds.push(`ffmpeg -ss ${clip.start.toFixed(2)} -i "${videoFilePath}" -t ${duration} -c:v libx264 -crf 18 -preset medium -c:a aac -b:a 192k "${out}"`);
                        } else {
                            // Stream copy mode (fast but may have frozen frames)
                            cmds.push(`ffmpeg -ss ${clip.start.toFixed(2)} -i "${videoFilePath}" -t ${duration} -c copy -avoid_negative_ts make_zero "${out}"`);
                        }
                    });
                } else {
                    const out = `${dir}${base}_full${ext}`;
                    cmds.push(`ffmpeg -i "${videoFilePath}" -c copy "${out}"`);
                }

                const fullCmd = cmds.join(sep);
                const modeLabel = encodingMode === 'reencode' ? 'Re-encoded' : 'Stream Copy';
                displayCommands(fullCmd, `Output: ${clips.length} clip(s) [${modeLabel}]${captureScreenshot ? ' + PNG' : ''}`);
            }

            function generateAudioCommand() {
                if (audioFormat === 'none') return;
                const dir = videoFilePath.includes('/') ? videoFilePath.substring(0, videoFilePath.lastIndexOf('/') + 1) :
                            videoFilePath.includes('\\') ? videoFilePath.substring(0, videoFilePath.lastIndexOf('\\') + 1) : '';
                const base = videoFilePath.split(/[\\/]/).pop().replace(/\.[^.]+$/, '');
                const ext = audioFormat === 'mp3' ? '.mp3' : '.wav';
                const out = `${dir}${base}_audio${ext}`;
                const cmd = audioFormat === 'mp3' ?
                    `ffmpeg -i "${videoFilePath}" -q:a 0 -map a "${out}"` :
                    `ffmpeg -i "${videoFilePath}" -acodec pcm_s16le "${out}"`;
                displayCommands(cmd, `Audio: ${audioFormat.toUpperCase()}`);
            }

            function displayCommands(cmd, label) {
                ffmpegCommands.innerHTML = `
                    <div class="command-label">${label}</div>
                    <div class="command-text">${escapeHtml(cmd)}</div>
                    <button class="copy-btn" id="copyBtn">Copy</button>
                `;
                ffmpegCommands.classList.add('show');
                ffmpegCommands.scrollIntoView({ behavior: 'smooth' });

                document.getElementById('copyBtn').addEventListener('click', () => {
                    navigator.clipboard.writeText(cmd).then(() => {
                        const btn = document.getElementById('copyBtn');
                        btn.textContent = 'Copied'; btn.classList.add('copied');
                        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
                    });
                });
            }

            function formatTime(s) { const m = Math.floor(s/60); const ss = Math.floor(s%60); return `${m}:${ss.toString().padStart(2,'0')}`; }
            function secToMMSS(s) { return formatTime(s); }
            function MMSStoSec(t) { const [m, s] = t.split(':').map(Number); return m*60 + s; }
            function escapeHtml(t) { const div = document.createElement('div'); div.textContent = t; return div.innerHTML; }
            function showNotification(msg, type = 'success') {
                const n = document.createElement('div'); n.className = 'notification'; n.textContent = msg;
                n.style.background = type === 'error' ? 'rgba(255,77,77,0.15)' : 'rgba(0,255,136,0.15)';
                n.style.color = type === 'error' ? '#ff6b6b' : '#00ff88';
                n.style.borderColor = type === 'error' ? 'rgba(255,77,77,0.4)' : 'rgba(0,255,136,0.4)';
                document.body.appendChild(n);
                setTimeout(() => n.classList.add('show'), 10);
                setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 300); }, 3000);
            }

            renderClips();
        });
    </script>
</body>
</html>
